# ArbitrageX 产品需求文档 (PRD)

## 1. 项目概述

### 1.1 项目名称
**ArbitrageX** - 跨交易所套利交易系统

### 1.2 项目背景
加密货币市场存在多个中心化交易所（CEX）和去中心化交易所（DEX），由于市场流动性、地域限制、信息传递延迟等因素，同一交易对在不同交易所之间存在价格差异。ArbitrageX 旨在利用这些价格差异，通过自动化系统在不同交易所之间进行低买高卖，实现无风险或低风险的套利收益。

### 1.3 项目目标
- 实时监控多个主流 CEX 和 DEX 的价格差异
- 快速识别套利机会并自动执行交易
- 支持主流交易对（BTC/USDT, BTC/USDC, ETH/USDT, ETH/USDC 等）
- 确保交易执行的高效性和安全性
- 提供完善的监控和告警机制

### 1.4 目标用户
- 量化交易团队
- 专业套利交易者
- 加密货币投资机构

## 2. 核心功能需求

### 2.1 套利策略设计

**概述**: 本章节详细定义不同套利场景的策略设计、资金准备方案和执行流程。

**核心设计原则**：
1. **速度优先**: 窗口期短的套利必须预先持有基础币种
2. **成功率优先**: 根据市场条件选择最优策略
3. **风险控制**: 避免因价格波动导致的持仓风险
4. **资金效率**: 平衡资金占用和套利机会捕获率

#### 2.1.1 场景分类矩阵

| 场景 | 描述 | 窗口期 | 主要风险 | 资金准备 | MVP优先级 |
|------|------|--------|----------|----------|-----------|
| **S1: CEX内部稳定币套利** | 同一CEX，BTC/USDT vs BTC/USDC | 极短 (< 1s) | 极低 | 预持有稳定币 | ⭐⭐⭐⭐⭐ |
| **S2: CEX-CEX相同交易对** | 不同CEX，BTC/USDT vs BTC/USDT | 短 (1-5s) | 低 | 预持有BTC + 稳定币 | ⭐⭐⭐⭐⭐ |
| **S3: CEX-CEX不同稳定币** | CEX1的BTC/USDT vs CEX2的BTC/USDC | 短 (1-5s) | 中等 | 预持有BTC + 双稳定币 | ⭐⭐⭐⭐ |
| **S4: CEX-DEX相同交易对** | CEX的BTC/USDT vs DEX的BTC/USDT | 中等 (几分钟) | 高 | 预持有或链上获取 | ⭐⭐⭐ |
| **S5: DEX-DEX相同交易对** | Uniswap的BTC/USDT vs SushiSwap的BTC/USDT | 中等 (几分钟) | 高 | 链上持有 | ⭐⭐ |

---

#### 2.1.2 场景 1: CEX内部稳定币套利（S1）

**场景描述**: 在同一CEX内，利用BTC/USDT和BTC/USDC之间的价差进行套利。

**典型案例**:
- Binance: BTC/USDT = 43,000
- Binance: BTC/USDC = 43,050
- 价差: 50 USDT (0.116%)

**资金准备策略**:

```
┌─────────────────────────────────────────────────────┐
│           资金准备：预持有模式                       │
├─────────────────────────────────────────────────────┤
│ 交易所: Binance                                     │
│                                                     │
│ 初始资金配置:                                       │
│  ├─ USDT:  10,000 (50%)                            │
│  ├─ USDC:  10,000 (50%)                            │
│  └─ BTC:    0 (不持有，避免价格波动风险)           │
│                                                     │
│ 总资金: 20,000 USDT等值                             │
└─────────────────────────────────────────────────────┘
```

**优势**:
- ✅ **速度极快**: 无需跨交易所转账，执行时间 < 500ms
- ✅ **无提现费用**: 无需支付提币手续费
- ✅ **无价格风险**: 不持有BTC，不受BTC价格波动影响
- ✅ **资金效率高**: 稳定币可以参与所有套利机会

**套利流程**:

```
【方向 A: USDT → USDC 套利】
条件: BTC/USDT < BTC/USDC

1. 机会识别
   ├─ BTC/USDT价格: 43,000
   ├─ BTC/USDC价格: 43,050
   ├─ 价差率: (43,050 - 43,000) / 43,000 = 0.116%
   ├─ 手续费: 买入0.1% + 卖出0.1% = 0.2%
   ├─ 滑点预估: 0.05%
   ├─ 总成本: 0.25%
   ├─ 净收益: 0.116% - 0.25% = -0.134% ❌
   └─ 结论: 不执行（收益率为负）

【方向 B: USDC → USDT 套利】
条件: BTC/USDT > BTC/USDC

1. 机会识别
   ├─ BTC/USDT价格: 43,050
   ├─ BTC/USDC价格: 43,000
   ├─ 价差率: (43,050 - 43,000) / 43,000 = 0.116%
   ├─ 手续费: 买入0.1% + 卖出0.1% = 0.2%
   ├─ 滑点预估: 0.05%
   ├─ 总成本: 0.25%
   ├─ 净收益: 0.116% - 0.25% = -0.134% ❌
   └─ 结论: 不执行（收益率为负）

💡 关键发现: 稳定币套利的手续费通常大于价差！
```

**实际套利阈值计算**:

```
最小盈利价差率 = 手续费 + 滑点 + 目标收益
                = 0.2% + 0.05% + 0.1%
                = 0.35%

只有当价差率 >= 0.35% 时，才执行套利
```

**特殊场景: 三角套利**

如果直接BTC/USDT vs BTC/USDC套利不盈利，可以尝试三角套利：

```
USDT → BTC → USDC → USDT

示例:
1. 用 10,000 USDT 买入 BTC (价格 43,000)
   得到: 0.23256 BTC

2. 用 BTC 卖出成 USDC (价格 43,050)
   得到: 10,011.62 USDC

3. 用 USDC 卖出成 USDT (价格 0.9999，USDC/USDT价差)
   得到: 10,010.62 USDT

净收益: 10.62 USDT (0.106%)

💡 三角套利可能发现单次套利看不到的机会
```

**风险控制**:
- 最小收益率阈值: 0.3%（考虑手续费后）
- 单笔最大金额: 5,000 USDT
- 稳定币余额监控: 保持 USDT 和 USDC 平衡

**MVP阶段建议**:
- ✅ **优先实现**: 这是风险最低、速度最快的套利类型
- ✅ **配置**: 每个CEX准备等额的 USDT 和 USDC
- ❌ **不持有BTC**: 避免价格波动风险

---

#### 2.1.3 场景 2: CEX-CEX相同交易对套利（S2）

**场景描述**: 不同CEX之间，相同交易对（如BTC/USDT）的价差套利。

**典型案例**:
- Binance: BTC/USDT = 43,000
- OKX: BTC/USDT = 43,150
- 价差: 150 USDT (0.349%)

**资金准备策略: 双向持仓模式**

```
┌─────────────────────────────────────────────────────┐
│        资金准备：双向持仓（推荐）                    │
├─────────────────────────────────────────────────────┤
│ Binance:                                            │
│  ├─ USDT:  5,000                                    │
│  └─ BTC:    0.1 (约 4,300 USDT)                     │
│                                                     │
│ OKX:                                                │
│  ├─ USDT:  5,000                                    │
│  └─ BTC:    0.1 (约 4,300 USDT)                     │
│                                                     │
│ 总资金: 20,000 USDT等值                             │
│ BTC持仓占比: 43%                                    │
└─────────────────────────────────────────────────────┘
```

**为什么双向持仓？**

```
方案 A: 仅持有稳定币（不推荐）
├─ 套利流程: 买入BTC → 跨交易所转账 → 卖出BTC
├─ 问题: 提现时间长（30分钟 - 2小时）
├─ 风险: 价差可能在提现期间消失
└─ 结论: ❌ 窗口期短的套利无法执行

方案 B: 双向持仓（推荐）
├─ 套利流程: 直接卖出BTC(低价) → 买入BTC(高价)
├─ 优势: 无需提现，执行时间 < 1秒
├─ 风险: 持有BTC的价格波动风险
└─ 结论: ✅ 速度最快，成功率最高
```

**套利流程（双向持仓模式）**:

```
【场景: Binance低价卖出，OKX高价买入】

前置条件:
├─ Binance持有: 0.1 BTC
├─ OKX持有: 5,000 USDT
└─ 价差: Binance 43,000 < OKX 43,150

执行流程:

1. 机会识别
   ├─ 价差率: 0.349%
   ├─ 手续费: 0.2%
   ├─ 滑点: 0.05%
   ├─ 净收益率: 0.349% - 0.25% = 0.099%
   └─ 判断: 0.099% < 0.5%，收益率过低，不执行 ❌

💡 如果价差 >= 0.5%：

2. 资金分配
   ├─ Binance可卖BTC: 0.1
   ├─ OKX可买BTC资金: 5,000 USDT
   └─ 决定交易金额: 0.1 BTC (约 4,300 USDT)

3. 并发执行
   ├─ Binance: 卖出 0.1 BTC @ 43,000 → 获得 4,295.7 USDT
   ├─ OKX: 买入 0.1 BTC @ 43,150 → 消耗 4,315.6 USDT
   └─ 执行时间: < 500ms

4. 结果
   ├─ Binance余额变化: BTC -0.1, USDT +4,295.7
   ├─ OKX余额变化: BTC +0.1, USDT -4,315.6
   ├─ 总收益: 4,315.6 - 4,295.7 = 19.9 USDT
   └─ 净收益率: 19.9 / 4,300 = 0.463%
```

**持仓平衡策略**:

```
问题: 多次套利后，各交易所BTC持仓会失衡
├─ Binance: BTC从 0.1 降至 0
├─ OKX: BTC从 0.1 增至 0.2

解决方案: 持仓再平衡

策略1: 通过套利自然平衡
├─ 当OKX BTC过多时，优先执行 OKX卖出 → Binance买入
└─ 价格合适时自动平衡

策略2: 主动转账平衡（仅在价差不利时）
├─ 当价差长期不利于持仓再平衡时
├─ 考虑直接转账BTC（成本: 提币费 + 时间）
└─ 触发条件: 持仓失衡 > 50%

策略3: 稳定币平衡（快速）
├─ 转账稳定币代替BTC
├─ 用稳定币重新买入BTC
└─ 成本更低，速度更快
```

**价格波动风险控制**:

```
风险场景: BTC价格暴跌时持有BTC

应对策略:
├─ 1. 实时监控BTC价格变化
│  └─ 如果1分钟内波动 > 2%，触发预警
│
├─ 2. 设置止损价格
│  └─ BTC跌破支撑位时，平仓止损
│
├─ 3. 对冲策略
│  ├─ 在期货市场开空单对冲
│  └─ 或购买看跌期权
│
└─ 4. 降低持仓比例
   ├─ 正常: 50% BTC + 50% USDT
   ├─ 高波动: 30% BTC + 70% USDT
   └─ 极端: 10% BTC + 90% USDT
```

**资金配置建议**:

```
针对主流币（BTC, ETH）:
├─ 推荐双向持仓
├─ BTC持仓: 40-50%
├─ ETH持仓: 40-50%
└─ 稳定币: 10-20%

针对小币种（DOT, LINK等）:
├─ 不推荐双向持仓
├─ 原因: 流动性差 + 持仓风险高
└─ 策略: 仅持有稳定币，接受较慢的套利速度
```

**MVP阶段建议**:
- ✅ **优先实现**: BTC/USDT 和 ETH/USDT
- ✅ **资金配置**: 每个CEX准备 50% BTC + 50% USDT
- ✅ **持仓再平衡**: 每24小时检查一次

---

#### 2.1.4 场景 3: CEX-CEX不同稳定币套利（S3）

**场景描述**: CEX1的BTC/USDT vs CEX2的BTC/USDC之间的套利。

**典型案例**:
- Binance: BTC/USDT = 43,000
- Coinbase: BTC/USDC = 43,100
- 价差: 100 USDT (0.233%)

**资金准备策略: 三向持仓模式**

```
┌─────────────────────────────────────────────────────┐
│        资金准备：三向持仓（推荐）                    │
├─────────────────────────────────────────────────────┤
│ Binance:                                            │
│  ├─ USDT:  5,000                                    │
│  └─ BTC:    0.05 (约 2,150 USDT)                   │
│                                                     │
│ Coinbase:                                          │
│  ├─ USDC:  5,000                                    │
│  └─ BTC:    0.05 (约 2,150 USDT)                   │
│                                                     │
│ 总资金: 20,000 USDT等值                             │
│ BTC持仓占比: 21.5%                                 │
└─────────────────────────────────────────────────────┘
```

**套利流程**:

```
【场景: Binance低价卖出BTC/USDT，Coinbase高价买入BTC/USDC】

方向 A: 卖出BTC换USDT → 买入BTC换USDC

1. 机会识别
   ├─ Binance BTC/USDT: 43,000
   ├─ Coinbase BTC/USDC: 43,100
   ├─ 价差率: 0.233%
   ├─ 手续费: 0.2%
   ├─ 滑点: 0.05%
   ├─ 稳定币价差风险: USDC/USDT可能 ≠ 1
   ├─ 净收益率: 0.233% - 0.25% = -0.017% ❌
   └─ 结论: 收益率为负

💡 关键问题: 不同稳定币之间的价差
   ├─ USDC/USDT 通常在 0.9998 - 1.0002 之间
   ├─ 如果 USDC/USDT = 0.9999
   └─ 实际损失: 0.01% = 4.3 USDT

方向 B: 反向套利（如果价差够大）

假设价差扩大到:
├─ Binance BTC/USDT: 43,000
├─ Coinbase BTC/USDC: 43,200 (价差 0.465%)
└─ 净收益: 0.465% - 0.25% - 0.01% = 0.205% ✅

执行:
├─ Binance: 卖出 0.05 BTC → 获得 2,147.9 USDT
├─ Coinbase: 买入 0.05 BTC → 消耗 2,159.1 USDC
├─ 净收益: 11.2 USDT
└─ 持仓变化: Binance BTC减少，Coinbase BTC增加
```

**稳定币价差风险**:

```
风险场景: USDT和USDC脱钩

历史案例:
├─ 2022年5月: USDC跌至 0.99 USDT
└─ 风险: 持有稳定币的汇率损失

应对策略:
├─ 1. 实时监控稳定币价差
│  └─ 如果 USDC/USDT < 0.999 或 > 1.001，暂停套利
│
├─ 2. 快速对冲
│  ├─ 在稳定币价差有利时进行兑换
│  └─ 例如: USDC高时，用USDC换USDT
│
└─ 3. 分散持仓
   ├─ 同时持有 USDT, USDC, DAI, BUSD
   └─ 降低单一稳定币脱钩风险
```

**持仓再平衡（复杂版）**:

```
问题: 套利后出现 3 种失衡
├─ BTC持仓失衡
├─ USDT持仓失衡
└─ USDC持仓失衡

平衡策略:

方案1: 自然平衡
├─ 等待反向套利机会
└─ 价格合适时自动平衡

方案2: 稳定币内部平衡
├─ 通过稳定币桥接
├─ 例如: Circle的USDC-USDT兑换（低费率）
└─ 成本: 0.01% - 0.05%

方案3: CEX内部转换
├─ 在CEX内直接 USDT ↔ USDC
├─ 费率: 通常 0.1%
└─ 速度: 即时
```

**资金配置建议**:

```
对于S3场景，资金配置需要更精细:

Binance:
├─ 50% USDT
├─ 25% BTC
└─ 25% USDC (通过内部转换获得)

Coinbase:
├─ 50% USDC
├─ 25% BTC
└─ 25% USDT (通过内部转换获得)

💡 为什么两边都要有USDT和USDC？
   因为套利方向不确定，需要双向准备
```

**MVP阶段建议**:
- ⚠️ **中期实现**: 复杂度较高
- ✅ **简化方案**: 先只做 S2（相同交易对），忽略S3
- ✅ **渐进实现**: MVP后支持

---

#### 2.1.5 场景 4: CEX-DEX套利（S4）

**场景描述**: CEX和DEX之间的价差套利。

**典型案例**:
- Binance (CEX): BTC/USDT = 43,000
- Uniswap (DEX): BTC/USDT = 43,200
- 价差: 200 USDT (0.465%)

**核心挑战**:
1. ⏱️ **时间长**: CEX提币到链上需要 30分钟 - 2小时
2. 🔗 **链上成本**: Gas费用、网络拥堵
3. 💰 **滑点大**: DEX流动性通常不如CEX
4. ⚠️ **风险高**: 链上交易不可撤销

**资金准备策略: 链上预持 + CEX准备**

```
┌─────────────────────────────────────────────────────┐
│        资金准备：链上+CEX混合模式                    │
├─────────────────────────────────────────────────────┤
│ CEX (Binance):                                      │
│  ├─ USDT:  10,000                                   │
│  └─ BTC:    0.1 (约 4,300 USDT)                     │
│                                                     │
│ 钱包 (Ethereum):                                    │
│  ├─ USDT (ERC20):  2,000                            │
│  ├─ BTC (WBTC):    0.05 (约 2,150 USDT)            │
│  └─ ETH:            0.5 (用于Gas费，约 1,500 USDT)   │
│                                                     │
│ 总资金: 25,000 USDT等值                             │
│ 链上资金占比: 22%                                   │
└─────────────────────────────────────────────────────┘
```

**为什么链上也要预持资金？**

```
方案 A: CEX提币模式（慢）
├─ 流程: CEX买入 → 提币到链上 → DEX卖出
├─ 时间: 30分钟 - 2小时
├─ 风险: 价差可能在提币期间消失
└─ 成功率: < 20%

方案 B: 链上预持模式（快）
├─ 流程: 链上代币 → DEX卖出 → CEX补充
├─ 时间: 1-5分钟（取决于网络）
├─ 风险: 链上拥堵时Gas费暴涨
└─ 成功率: > 80%

结论: ✅ 推荐链上预持
```

**套利流程（CEX → DEX）**:

```
【场景: Binance低价，Uniswap高价】

前置条件:
├─ Binance: BTC/USDT = 43,000
├─ Uniswap: BTC/USDT = 43,200 (WBTC/USDT)
├─ 价差率: 0.465%
├─ 链上持有: 0.05 WBTC

1. 成本计算
   ├─ CEX手续费: 0.1%
   ├─ DEX手续费: 0.3% (Uniswap)
   ├─ Gas费: 约 10 USDT (Ethereum)
   ├─ 滑点: 0.5% (DEX流动性差)
   ├─ 总成本: 0.1% + 0.3% + (10/4300) + 0.5% = 1.13%
   ├─ 净收益: 0.465% - 1.13% = -0.665% ❌
   └─ 结论: 不执行

💡 关键发现: DEX套利的成本远高于CEX！

必须满足: 价差率 >= 1.5% 才考虑执行
```

**套利流程（DEX → CEX）**:

```
【场景: Uniswap低价，Binance高价】

前置条件:
├─ Uniswap: WBTC/USDT = 42,800
├─ Binance: BTC/USDT = 43,000
├─ 价差率: 0.467%

1. 成本计算
   ├─ DEX买入手续费: 0.3%
   ├─ Gas费: 15 USDT
   ├─ 跨链桥费用: 0 USDT (假设已是WBTC)
   ├─ CEX充值: 免费
   ├─ CEX卖出手续费: 0.1%
   ├─ 总成本: 0.4% + (15/42800) = 0.75%
   ├─ 净收益: 0.467% - 0.75% = -0.283% ❌
   └─ 结论: 不执行

💡 DEX → CEX 也很难盈利！
```

**提高DEX套利盈利性的策略**:

```
策略1: 等待超大价差
├─ 触发阈值: 2% - 3%
├─ 发生频率: 市场剧烈波动时
└─ 机会: 牛市/熊市转换期

策略2: 使用低Gas费链
├─ Ethereum: Gas 10-50 USDT
├─ Polygon: Gas 0.01-0.1 USDT
├─ BSC: Gas 0.1-0.5 USDT
└─ Arbitrum: Gas 0.1-1 USDT

策略3: 聚合器优化
├─ 使用 1inch, Matcha 等聚合器
├─ 自动寻找最优路径
└─ 降低滑点 20-30%

策略4: Flash Loan套利（高级）
├─ 无需预持资金
├─ 借款 → 套利 → 还款（在同一交易内）
├─ 风险: 需要智能合约编程
└─ 收益: 可以覆盖大部分成本
```

**DEX套利决策树**:

```
发现CEX-DEX价差
    │
    ├─ 价差 < 1.5%
    │   └─ ❌ 放弃（成本太高）
    │
    ├─ 价差 >= 1.5%
    │   │
    │   ├─ 链上已持有代币
    │   │   └─ ✅ 执行套利
    │   │
    │   └─ 链上未持有代币
    │       │
    │       ├─ 预期价差 > 3%
    │       │   └─ ✅ 提币套利（虽然有延迟）
    │       │
    │       └─ 预期价差 1.5% - 3%
    │           └─ ⚠️ 观察等待（价差可能扩大）
    │
    └─ Gas费异常高（> 50 USDT）
        └─ ❌ 放弃（Gas费吞噬利润）
```

**资金配置建议**:

```
对于S4场景，建议配置:

CEX (Binance):
├─ 70% USDT (主力资金)
├─ 20% BTC
└─ 10% 其他代币

链上 (Ethereum + L2):
├─ 50% USDT (稳定币)
├─ 30% WBTC (主流币)
├─ 10% ETH (Gas费)
└─ 10% 其他代币

💡 资金分配原则:
   - CEX: 70-80% (流动性好，手续费低)
   - 链上: 20-30% (应对DEX套利机会)
```

**风险控制**:

```
DEX特有风险:

1. 智能合约风险
   ├─ 使用经过审计的DEX
   └─ 避免使用新上线的小型DEX

2. 链上拥堵风险
   ├─ Gas费暴涨导致亏损
   └─ 交易失败风险

3. 滑点风险
   ├─ DEX流动性不如CEX
   └─ 设置滑点保护 (1-2%)

4. 跨链桥风险
   ├─ 跨链桥可能被攻击
   └─ 使用主流跨链桥 (如 Circle, Wormhole)
```

**MVP阶段建议**:
- ❌ **MVP不实现**: 复杂度高，收益不稳定
- ✅ **Phase 2实现**: 在DEX支持完善后
- ✅ **优先级**: S1 > S2 > S3 > S4 > S5

---

#### 2.1.6 场景 5: DEX-DEX套利（S5）

**场景描述**: 不同DEX之间的价差套利。

**典型案例**:
- Uniswap: WBTC/USDT = 43,000
- SushiSwap: WBTC/USDT = 43,100
- 价差: 100 USDT (0.233%)

**核心特点**:
- ✅ **无需跨链**: 同链DEX之间转账极快
- ⚠️ **Gas费高**: 每笔交易需要支付Gas
- 📊 **滑点大**: DEX池子深度有限

**资金准备策略: 全链上模式**

```
┌─────────────────────────────────────────────────────┐
│        资金准备：全链上持有                          │
├─────────────────────────────────────────────────────┤
│ Ethereum 钱包:                                     │
│  ├─ USDT:     3,000                                │
│  ├─ WBTC:     0.07 (约 3,010 USDT)                 │
│  ├─ ETH:      1.0 (约 3,000 USDT, 用于Gas)          │
│  └─ Uni V2 LP: 提供流动性，赚取手续费              │
│                                                     │
│ 总资金: 12,000 USDT等值                             │
└─────────────────────────────────────────────────────┘
```

**套利流程**:

```
【场景: Uniswap低价，SushiSwap高价】

1. 机会识别
   ├─ Uniswap: WBTC/USDT = 43,000
   ├─ SushiSwap: WBTC/USDT = 43,100
   ├─ 价差率: 0.233%

2. 成本计算
   ├─ Uniswap手续费: 0.3%
   ├─ SushiSwap手续费: 0.3%
   ├─ Gas费 (2笔交易): 20 USDT
   ├─ 滑点: 0.5% × 2 = 1%
   ├─ 总成本: 0.6% + (20/4300) + 1% = 2.065%
   ├─ 净收益: 0.233% - 2.065% = -1.832% ❌
   └─ 结论: 不执行

💡 DEX-DEX套利成本最高！
   唯一优势: 速度快（几秒到几分钟）
```

**什么时候DEX-DEX套利才盈利？**

```
情景1: 极端价差
├─ 黑天鹅事件（交易所被盗、监管打击）
├─ 单一DEX流动性枯竭
└─ 价差 > 3%

情景2: 使用Flash Loans
├─ 无需预持资金
├─ 闪电贷 → 套利 → 还款（一笔交易）
├─ 代码示例:
│  1. 借款 100,000 USDT (Aave)
│  2. Uniswap买入 2.3 WBTC
│  3. SushiSwap卖出 2.3 WBTC
│  4. 还款 100,000 USDT + 0.09% 利息
│  5. 利润 = 3% - 0.3% - 0.09% - Gas = 2.5% ✅
└─ 需要: 智能合约开发能力

情景3: 套利机器人（MEV）
├─ 监控Mempool中的待处理交易
├─ 抢跑（Front-running）其他套利者
├─ 使用Flashbots等私有矿池
└─ 需要: 高级技术 + MEV经验
```

**DEX套利决策矩阵**:

| 价差率 | 资金准备 | Gas费环境 | 决策 |
|--------|----------|-----------|------|
| < 1.5% | 预持有 | 正常 (10-20 USDT) | ❌ 放弃 |
| < 1.5% | 预持有 | 低 (1-5 USDT, L2) | ⚠️ 观望 |
| 1.5% - 3% | 预持有 | 正常 | ⚠️ 观望 |
| 1.5% - 3% | Flash Loan | 正常 | ✅ 可执行 |
| > 3% | 预持有 | 正常 | ✅ 执行 |
| > 3% | Flash Loan | 高 (50+ USDT) | ⚠️ 谨慎 |

**针对小币种的策略**:

```
问题: 小币种（如代币A）无法预持

场景: CEX1的TokenA/USDT vs CEX2的TokenA/USDT

唯一可行的策略: 买入 → 提币 → 卖出

1. CEX1 买入 TokenA
2. 提币到 CEX2
3. CEX2 卖出 TokenA

执行条件:
├─ 价差必须 >= 5% (覆盖手续费 + 提币费 + 时间成本)
├─ 预期提币时间 < 2小时
└─ TokenA 价格波动风险可控

风险:
├─ 提币期间价格暴跌
├─ TokenA 可能下架
└─ 流动性可能枯竭

应对:
├─ 设置止损单
├─ 分批提币
└─ 限制单笔金额
```

**MVP阶段建议**:
- ❌ **MVP不实现**: 收益不稳定，技术复杂
- ⚠️ **Phase 3考虑**: 仅在Flash Loan技术成熟后
- ✅ **优先级**: 最低

---

#### 2.1.7 综合套利策略矩阵

基于以上5种场景的分析，我们给出综合策略建议：

```
┌─────────────────────────────────────────────────────────┐
│              套利场景优先级与资源分配                    │
├──────┬───────────┬──────────┬──────────┬────────┬──────┤
│ 场景 │ 描述      │ 窗口期   │ 盈利阈值 │ 优先级│资源  │
├──────┼───────────┼──────────┼──────────┼────────┼──────┤
│  S1  │ CEX内部   │ < 1秒    │ 0.35%    │ ⭐⭐⭐⭐⭐│ 20%  │
│      │ 稳定币    │          │          │        │      │
├──────┼───────────┼──────────┼──────────┼────────┼──────┤
│  S2  │ CEX-CEX   │ 1-5秒    │ 0.5%     │ ⭐⭐⭐⭐⭐│ 50%  │
│      │ 相同交易对│          │          │        │      │
├──────┼───────────┼──────────┼──────────┼────────┼──────┤
│  S3  │ CEX-CEX   │ 1-5秒    │ 0.6%     │ ⭐⭐⭐⭐ │ 15%  │
│      │ 不同稳定币│          │          │        │      │
├──────┼───────────┼──────────┼──────────┼────────┼──────┤
│  S4  │ CEX-DEX   │ 分钟级   │ 1.5%     │ ⭐⭐⭐  │ 10%  │
│      │          │          │          │        │      │
├──────┼───────────┼──────────┼──────────┼────────┼──────┤
│  S5  │ DEX-DEX   │ 分钟级   │ 3%       │ ⭐⭐   │ 5%   │
│      │          │          │          │        │      │
└──────┴───────────┴──────────┴──────────┴────────┴──────┘
```

**MVP阶段资金配置建议**:

```
总资金: 100,000 USDT

分配方案:
├─ CEX1 (Binance): 40,000 USDT
│  ├─ USDT:  20,000 (50%)
│  ├─ USDC:  5,000 (12.5%)
│  ├─ BTC:   0.47 (约 20,000 USDT, 37.5%)
│  └─ ETH:   0.95 (约 2,000 USDT, 5%)
│
├─ CEX2 (OKX): 40,000 USDT
│  ├─ USDT:  20,000 (50%)
│  ├─ USDC:  5,000 (12.5%)
│  ├─ BTC:   0.47 (约 20,000 USDT, 37.5%)
│  └─ ETH:   0.95 (约 2,000 USDT, 5%)
│
└─ 钱包 (链上): 20,000 USDT
   ├─ USDT:  10,000 (50%)
   ├─ WBTC:  0.23 (约 10,000 USDT, 50%)
   └─ ETH:   1.0 (约 3,000 USDT, Gas费)

💡 资金分配原则:
   - 主力: CEX-CEX套利 (80%)
   - 辅助: CEX-DEX套利 (15%)
   - 探索: DEX-DEX套利 (5%)

💡 持仓比例原则:
   - 主流币 (BTC, ETH): 预持有 40-50%
   - 稳定币 (USDT, USDC): 保留 50-60%
   - 小币种: 不预持有，按需买入
```

**动态持仓调整策略**:

```
根据市场波动调整持仓比例:

低波动期 (BTC 1小时波动 < 1%):
├─ BTC持仓: 50%
├─ 稳定币: 50%
└─ 策略: 积极套利，最大化收益

中等波动 (BTC 1小时波动 1-3%):
├─ BTC持仓: 30%
├─ 稳定币: 70%
└─ 策略: 谨慎套利，提高风控

高波动 (BTC 1小时波动 > 3%):
├─ BTC持仓: 10%
├─ 稳定币: 90%
└─ 策略: 降低套利频率，优先保值

极端行情 (单日涨跌 > 10%):
├─ BTC持仓: 0-5%
├─ 稳定币: 95-100%
└─ 策略: 暂停套利，观望为主
```

**小币种套利专项策略**:

```
对于无法预持的小币种:

策略 A: 提币模式（慢）
├─ 适用场景: 价差 > 5%
├─ 流程: 买入 → 提币 → 卖出
├─ 时间: 30分钟 - 2小时
└─ 风险: 高

策略 B: 放弃（推荐）
├─ 适用场景: 价差 < 5%
├─ 原因: 风险收益比不合理
├─ 替代: 聚焦主流币套利
└─ 风险: 低

💡 建议: MVP阶段仅支持主流币 (BTC, ETH, USDT, USDC)
       Phase 2 再考虑小币种
```

---

### 2.2 价格监控模块
**功能描述**: 实时获取并监控各交易所的交易对价格

**详细需求**:
- 支持多个主流 CEX（Binance, OKX, Bybit, Coinbase 等）
- 支持多个主流 DEX（Uniswap, SushiSwap, PancakeSwap 等）
- 实时获取交易对的买一价、卖一价、买一量、卖一量
- 支持至少 20 个主流交易对
- 价格更新频率：CEX ≤ 100ms，DEX ≤ 500ms
- 记录历史价格数据，用于分析和回测

**验收标准**:
- 能够同时监控至少 10 个交易所
- 价格延迟不超过规定阈值
- 数据获取成功率 ≥ 99.9%

### 2.2 套利机会识别模块
**功能描述**: 分析价格差异，识别有利可图的套利机会

**详细需求**:

#### 2.2.1 价格差计算
- 实时计算同一交易对在不同交易所的价格差
- 计算公式：`价格差 = 卖出价 - 买入价`
- 计算价差率：`价差率 = (卖出价 - 买入价) / 买入价 × 100%`
- 支持双向价差计算（A→B 和 B→A）

#### 2.2.2 成本计算
- **交易手续费**：
  - Maker 费率：挂单费率（通常 0.1% - 0.2%）
  - Taker 费率：吃单费率（通常 0.2% - 0.5%）
  - 双边手续费：买入手续费 + 卖出手续费
- **滑点成本**：
  - 根据订单簿深度估算滑点
  - 使用恒定乘积公式（DEX）或订单簿分析（CEX）
- **提币费用**（CEX-DEX 或跨交易所场景）：
  - 提币手续费（固定金额或费率）
  - 网络确认时间成本
- **资金成本**：
  - 资金占用时间 × 资金成本率

#### 2.2.3 收益计算
- **毛收益率**：`(卖出价 - 买入价) / 买入价 × 100%`
- **净收益率**：`毛收益率 - 交易手续费 - 滑点成本 - 提币费用`
- **绝对收益**：`交易金额 × 净收益率`
- **年化收益率**：`净收益率 × (365 / 资金占用天数)`

#### 2.2.4 决策规则
- **最小收益率阈值**（可配置）：
  - 默认值：0.5%
  - 可根据交易对、市场波动动态调整
- **最小交易金额**（可配置）：
  - 考虑交易所最小订单限制
  - 考虑固定成本分摊
- **深度检查**：
  - 买一量是否满足交易金额
  - 大额交易分批执行策略
- **时效性检查**：
  - 价格数据时效性（≤ 500ms）
  - 超时数据自动丢弃

#### 2.2.5 优先级排序
当同时出现多个套利机会时，按以下优先级排序：
1. **收益率**：收益率高的优先
2. **交易金额**：金额适中的优先（过小不划算，过大风险高）
3. **流动性**：流动性好的优先
4. **执行速度**：API 响应快的优先

#### 2.2.6 套利模式
- **CEX <-> CEX**（MVP 重点）：
  - 买低卖高，无跨链转账
  - 执行时间：< 1 秒
  - 风险：低
- **CEX <-> DEX**（Phase 2）：
  - 需要跨链转账
  - 执行时间：几分钟到几十分钟
  - 风险：中等
- **DEX <-> DEX**（Phase 2）：
  - 链内或跨链套利
  - 执行时间：取决于网络确认
  - 风险：中高

**验收标准**:
- 套利机会识别延迟 ≤ 50ms
- 套利收益率计算准确率 100%
- 支持至少 3 种套利模式
- 成本计算误差 ≤ 0.01%

### 2.3 交易执行模块
**功能描述**: 自动执行套利交易

**详细需求**:

#### 2.3.1 交易策略
- **订单类型选择**：
  - 优先使用**限价单**（降低滑点成本）
  - 流动性不足时使用**市价单**（确保成交）
  - DEX 必须使用限价单（通过滑点保护）
- **下单策略**：
  - 同时下单：买入和卖出订单同时提交（减少时间差风险）
  - 限价价格设置：
    - 买入价：当前买一价或略高（确保成交）
    - 卖出价：当前卖一价或略低（确保成交）
  - 价格保护：设置滑点容忍度（默认 0.1%）
- **交易金额计算**：
  - 根据账户余额动态调整
  - 根据订单簿深度决定交易金额
  - 单笔交易不超过账户余额的 20%

#### 2.3.2 执行流程（CEX-CEX）
```
1. 前置检查
   ├─ 检查账户余额是否充足
   ├─ 检查风险控制限制（单笔、日累计）
   ├─ 检查价格数据时效性
   └─ 检查交易所 API 状态

2. 订单创建
   ├─ 创建买入订单（低价交易所）
   ├─ 创建卖出订单（高价交易所）
   └─ 记录订单关联关系

3. 并发执行
   ├─ 同时提交买入和卖出订单
   ├─ 启动超时计时器（默认 5 秒）
   └─ 等待订单成交

4. 状态监控
   ├─ 轮询订单状态（间隔 100ms）
   ├─ 检查订单是否成交
   └─ 检查订单是否超时

5. 成交处理
   ├─ 检查订单成交状态
   ├─ 计算实际收益
   ├─ 更新账户余额
   └─ 记录交易日志

6. 异常处理（见 2.3.3）
```

#### 2.3.3 异常处理机制

**场景 1：买入订单成交，卖出订单失败**
- 处理策略：
  - 立即取消卖出订单（如果已挂单）
  - 在卖出交易所重新挂单（最多重试 3 次）
  - 如果仍失败，持有资产，等待下一次机会
  - 触发告警：卖出失败，持有资产
- 风险评估：持有资产价格波动风险

**场景 2：卖出订单成交，买入订单失败**
- 处理策略：
  - 立即取消买入订单
  - 在买入交易所重新下单（最多重试 3 次）
  - 如果仍失败，触发紧急借贷或使用其他交易所资金
  - 触发告警：买入失败，可能面临交割违约
- 风险评估：可能导致交割违约，信用风险

**场景 3：两个订单都失败**
- 处理策略：
  - 取消所有未成交订单
  - 检查失败原因（余额不足、网络问题、API 限流）
  - 根据原因调整后重试
  - 放弃本次套利机会
- 风险评估：无资金损失，但损失机会成本

**场景 4：订单部分成交**
- 处理策略：
  - 检查成交比例
  - 如果成交比例 ≥ 80%，视为成功
  - 如果成交比例 < 80%，尝试补单
  - 无法补单时，按实际成交金额计算收益
  - 记录部分成交日志

**场景 5：订单超时**
- 处理策略：
  - 查询订单最新状态
  - 如果已部分成交，按部分成交处理
  - 如果未成交，取消订单
  - 记录超时日志，调整超时阈值

**场景 6：价格发生不利变化**
- 处理策略：
  - 实时监控价格变化
  - 如果价差缩小至阈值以下，立即取消订单
  - 设置价格保护：滑点超过 0.1% 自动撤销订单
  - 触发风控熔断，暂停交易 1 分钟

**场景 7：交易所 API 返回错误**
- 处理策略：
  - 解析错误码和错误信息
  - 临时性错误（网络超时、限流）：指数退避重试
  - 永久性错误（余额不足、权限不足）：放弃交易
  - 未知错误：记录日志，触发告警

**场景 8：DEX 交易失败**
- 处理策略：
  - 检查交易失败原因（Gas 不足、滑点过大）
  - 如果是 Gas 费用问题，调整 Gas 价格重新提交
  - 如果是滑点过大，调整交易金额
  - 记录 Gas 费用损失

#### 2.3.4 并发控制
- 支持同时执行多个套利机会（最多 10 个）
- 资金隔离：不同套利机会使用独立的资金池
- 防止重复交易：同一交易对在短时间内不重复执行
- 交易所限流：每个交易所的请求队列隔离

#### 2.3.5 订单跟踪
- 实时跟踪订单状态（已创建、已挂单、部分成交、完全成交、已取消）
- 记录订单生命周期（创建时间、成交时间、取消时间）
- 记录订单详情（价格、数量、手续费、成交均价）

**验收标准**:
- 订单下单延迟 ≤ 100ms
- 交易成功率 ≥ 95%
- 支持并发执行多个套利机会（最多 10 个）
- 异常处理覆盖率 100%
- 订单状态跟踪准确率 100%

### 2.4 风险控制模块
**功能描述**: 控制交易风险，保护资金安全

**详细需求**:

#### 2.4.1 资金管理策略

**资金分配原则**：
- **多交易所分散**：
  - 每个交易所分配资金 = 总资金 / 交易所数量
  - 保留 20% 作为缓冲资金（不参与交易）
  - 单交易所资金占比不超过总资金的 40%
- **流动性管理**：
  - 资金利用率目标：60% - 80%
  - 避免资金过度集中（单交易所 ≤ 40%）
  - 避免资金过度分散（单交易所 ≥ 10%）

**单笔交易金额计算**：
```go
// 伪代码示例
func calculateTradeAmount(opportunity Opportunity) float64 {
    // 因素 1: 账户余额
    maxByBalance := min(buyExchangeBalance, sellExchangeBalance) * 0.2 // 不超过余额的 20%

    // 因素 2: 风险限制
    maxByRisk := config.MaxTradeAmount // 配置的单笔最大金额

    // 因素 3: 订单簿深度
    maxByDepth := min(buyDepth, sellDepth) * 0.5 // 不超过深度的 50%

    // 因素 4: 收益率（收益率越高，交易金额越大）
    multiplier := min(opportunity.profitRate / 0.01, 2.0) // 收益率 1% 时为 1 倍，最大 2 倍

    // 取最小值并应用收益率乘数
    return min(maxByBalance, maxByRisk, maxByDepth) * multiplier
}
```

**资金使用优先级**：
1. 优先使用持仓较多的交易所（平衡资金分布）
2. 优先使用流动性好的交易所（降低滑点）
3. 优先使用费率较低的交易所（降低成本）

#### 2.4.2 交易限制规则

**单笔交易限制**（可配置）：
- 最大交易金额：默认 1000 USDT
- 最小交易金额：默认 10 USDT
- 单笔占账户余额比例：≤ 20%

**日交易限制**（可配置）：
- 日交易总金额：默认 10,000 USDT
- 日交易次数：默认 100 次
- 日亏损上限：默认 500 USDT（或总资金的 5%）

**单交易所限制**（可配置）：
- 单交易所持仓占比：≤ 40%
- 单交易所日交易次数：≤ 50 次
- 单交易所连续失败次数：≤ 3 次（触发熔断）

**交易对限制**（可配置）：
- 支持的交易对白名单
- 禁止的交易对黑名单
- 单交易对日交易次数：≤ 20 次

#### 2.4.3 熔断机制

**触发条件**（满足任一条件即触发）：
1. **亏损熔断**：
   - 连续亏损次数 ≥ 3 次
   - 日累计亏损 ≥ 500 USDT
   - 单笔亏损 ≥ 100 USDT
2. **异常熔断**：
   - 交易成功率 < 80%（最近 20 笔）
   - API 失败率 > 10%（最近 100 次调用）
   - 价格数据延迟 > 1 秒
3. **市场熔断**：
   - 单交易对价格波动 > 10%（1 分钟内）
   - 所有交易所价格差异 > 5%（异常套利）
   - 交易所维护或下架交易对
4. **系统熔断**：
   - 系统负载过高（CPU > 90%，持续 1 分钟）
   - 内存使用率 > 90%
   - 数据库连接失败

**熔断动作**：
- 立即停止所有新交易
- 取消所有未成交订单
- 暂停价格监控（可选）
- 触发紧急告警

**熔断恢复**：
- 熔断后等待 5 分钟（可配置）
- 检查触发条件是否消除
- 手动确认后恢复交易（生产环境）
- 自动恢复（测试环境）

#### 2.4.4 余额监控

**实时监控指标**：
- 各交易所余额（USDT、BTC、ETH 等）
- 资金利用率（已用资金 / 总资金）
- 资金分布合理性（标准差）
- 余额变化趋势

**告警阈值**：
- 余额不足：单交易所余额 < 100 USDT
- 资金利用率过高：> 90%
- 资金利用率过低：< 30%
- 余额异常波动：5 分钟内变化 > 20%

#### 2.4.5 API 密钥安全

**权限最小化**：
- 只开启必要的权限：
  - ✅ 查询账户余额
  - ✅ 下单交易
  - ✅ 查询订单状态
  - ❌ 提币（禁止）
  - ❌ 转账（禁止）
- 使用只读 API Key 用于监控
- 使用交易 API Key 用于执行

**IP 白名单**：
- 配置服务器 IP 白名单
- 定期更新白名单
- 记录所有 API 调用日志

**密钥轮换**：
- 每 90 天轮换一次 API 密钥
- 密钥泄露时立即更换
- 支持多套密钥配置（主备切换）

#### 2.4.6 风险指标计算

**实时风险指标**：
- **当前收益率**：(实际收益 / 交易金额) × 100%
- **胜率**：盈利次数 / 总交易次数
- **最大回撤**：(最高净值 - 当前净值) / 最高净值
- **夏普比率**：(收益率 - 无风险利率) / 收益率标准差
- **资金周转率**：交易总额 / 平均资金

**风险告警**：
- 胜率 < 60%（最近 20 笔）
- 最大回撤 > 5%
- 资金周转率 < 1（资金利用不足）
- 资金周转率 > 10（过度交易）

**验收标准**:
- 所有限制都通过配置文件控制
- 熔断响应时间 ≤ 1s
- 风险控制规则覆盖率 100%
- 资金管理策略可配置
- 风险指标实时计算（延迟 ≤ 5s）

### 2.5 账户管理模块
**功能描述**: 管理多个交易所账户

**详细需求**:
- 支持配置多个交易所账户
- API Key 和 Secret 安全存储（加密）
- 账户余额实时查询
- 账户资产分布展示
- 账户权限管理（只读/交易）
- 账户健康状态检查

**验收标准**:
- 敏感信息加密存储（AES-256）
- 支持至少 5 个交易所账户
- 账户余额查询延迟 ≤ 500ms

### 2.6 配置管理模块
**功能描述**: 灵活的配置管理系统

**详细需求**:
- 所有配置项通过配置文件管理
- 支持多环境配置（dev/test/prod）
- 配置热更新（无需重启服务）
- 配置项验证
- 敏感配置独立加密存储

**验收标准**:
- 配置项覆盖率 100%
- 配置更新延迟 ≤ 5s
- 配置验证失败拒绝启动

### 2.7 日志与监控模块
**功能描述**: 完善的日志记录和系统监控

**详细需求**:
- 结构化日志输出（JSON 格式）
- 日志级别管理（DEBUG/INFO/WARN/ERROR）
- 交易日志完整记录
- 系统性能指标监控（CPU、内存、Goroutine）
- 套利机会监控
- 交易成功率监控
- 收益统计与分析

**验收标准**:
- 日志完整性 100%
- 监控数据实时更新
- 支持日志导出和分析

### 2.8 告警模块
**功能描述**: 及时通知异常情况和重要事件

**详细需求**:
- 交易失败告警
- 套利收益率异常告警
- 账户余额不足告警
- API 调用失败告警
- 系统异常告警
- 支持多种告警方式（邮件、Telegram、企业微信）
- 告警去重和聚合

**验收标准**:
- 告警发送延迟 ≤ 10s
- 告警准确率 ≥ 99%
- 支持至少 2 种告警方式

## 3. 非功能需求

### 3.1 性能要求
- 系统响应时间：
  - 价格监控：≤ 100ms
  - 套利识别：≤ 50ms
  - 订单下单：≤ 100ms
- 系统吞吐量：
  - 支持同时监控 100+ 交易对
  - 支持并发执行 10+ 套利交易
- 资源占用：
  - CPU 使用率 ≤ 70%（正常负载）
  - 内存占用 ≤ 2GB
  - 网络带宽 ≤ 10Mbps

### 3.2 可靠性要求
- 系统可用性：≥ 99.5%
- 数据一致性：强一致性
- 故障恢复时间：≤ 5 分钟
- 数据备份：每日自动备份

### 3.3 安全性要求
- API 密钥加密存储（AES-256）
- 支持 IP 白名单
- 操作日志审计
- 敏感信息脱敏显示
- 支持 2FA（双因素认证）
- 定期安全审计

### 3.4 可扩展性要求
- 模块化设计，易于添加新交易所
- 支持水平扩展
- 配置化的交易对管理
- 插件化的告警方式

### 3.5 可维护性要求
- 代码注释覆盖率 ≥ 80%
- 单元测试覆盖率 ≥ 70%
- 完善的文档
- 清晰的日志记录
- 便于问题定位和排查

## 4. 数据需求

### 4.1 核心数据实体
- 交易所信息
- 交易对信息
- 价格数据
- 订单数据
- 交易记录
- 账户信息
- 套利机会记录
- 系统配置

### 4.2 数据存储
- 价格数据：时序数据库（可选，初期可使用文件存储）
- 交易记录：关系型数据库（PostgreSQL/MySQL）
- 配置数据：YAML/JSON 文件
- 日志数据：日志文件 + 可选的日志收集系统

### 4.3 数据保留策略
- 实时价格数据：保留 24 小时
- 历史价格数据：保留 30 天
- 交易记录：永久保留
- 日志数据：保留 90 天
- 套利机会记录：保留 90 天

## 5. 接口需求

### 5.1 外部接口
- 交易所 REST API（获取账户信息、下单等）
- 交易所 WebSocket API（实时价格推送）
- 告警服务接口（邮件、Telegram、企业微信）

### 5.2 内部接口
- 价格监控模块 → 套利识别模块
- 套利识别模块 → 交易执行模块
- 各模块 → 日志监控模块
- 各模块 → 告警模块

### 5.3 管理接口（可选）
- HTTP API 用于查询系统状态
- CLI 命令行工具用于系统管理

## 6. 核心业务流程

### 6.1 CEX-CEX 套利完整流程

**场景**: Binance BTC/USDT 价格 43,000，OKX BTC/USDT 价格 43,150

```
┌─────────────────────────────────────────────────────────────┐
│                      套利流程概览                            │
└─────────────────────────────────────────────────────────────┘

1. 【价格监控阶段】
   ├─ Binance WebSocket 推送: BTC/USDT 买一价 43,000
   ├─ OKX WebSocket 推送: BTC/USDT 卖一价 43,150
   ├─ 价格差: 150 USDT
   ├─ 价差率: (43,150 - 43,000) / 43,000 = 0.349%
   └─ 时间戳: 2026-01-06 10:30:00.123

2. 【套利机会识别阶段】
   ├─ 计算成本:
   │  ├─ Binance 买入手续费 (Taker 0.1%): 43,000 × 0.1% = 43 USDT
   │  ├─ OKX 卖出手续费 (Taker 0.1%): 43,150 × 0.1% = 43.15 USDT
   │  ├─ 预估滑点: 0.05% × 2 = 0.1% ≈ 43 USDT
   │  └─ 总成本: 43 + 43.15 + 43 = 129.15 USDT
   │
   ├─ 计算收益:
   │  ├─ 毛收益: 43,150 - 43,000 = 150 USDT
   │  ├─ 净收益: 150 - 129.15 = 20.85 USDT
   │  └─ 净收益率: 20.85 / 43,000 = 0.0485%
   │
   ├─ 决策判断:
   │  ├─ 净收益率 0.0485% < 最小阈值 0.5% ❌
   │  ├─ 结论: 收益率过低，放弃本次机会
   │  └─ 原因: 手续费和滑点抵消了大部分收益
   │
   └─ 【如果收益率 >= 0.5%，继续执行】

3. 【前置检查阶段】（假设收益率达标）
   ├─ 账户余额检查:
   │  ├─ Binance USDT 余额: 10,000 ✅ (充足)
   │  ├─ OKX BTC 余额: 0.25 ✅ (充足)
   │  └─ 计算交易金额: min(10000, 0.25×43000) × 0.2 = 860 USDT
   │
   ├─ 风险控制检查:
   │  ├─ 单笔交易金额 860 < 最大限制 1000 ✅
   │  ├─ 日累计交易金额 2,340 < 日限制 10,000 ✅
   │  ├─ 连续亏损次数 0 < 阈值 3 ✅
   │  └─ 熔断器状态: 正常 ✅
   │
   ├─ 价格数据时效性:
   │  ├─ Binance 价格延迟: 50ms ✅
   │  ├─ OKX 价格延迟: 45ms ✅
   │  └─ 时间差: 5ms ✅
   │
   └─ 交易所 API 状态:
      ├─ Binance API: 正常 ✅
      └─ OKX API: 正常 ✅

4. 【订单执行阶段】
   ├─ 创建订单 (10:30:00.200):
   │  ├─ 买入订单 (Binance):
   │  │  ├─ 交易对: BTC/USDT
   │  │  ├─ 方向: BUY
   │  │  ├─ 类型: LIMIT (限价单)
   │  │  ├─ 价格: 43,000 (当前买一价)
   │  │  ├─ 数量: 0.02 BTC (约 860 USDT)
   │  │  └─ 订单 ID: local_order_001
   │  │
   │  └─ 卖出订单 (OKX):
   │     ├─ 交易对: BTC/USDT
   │     ├─ 方向: SELL
   │     ├─ 类型: LIMIT (限价单)
   │     ├─ 价格: 43,150 (当前卖一价)
   │     ├─ 数量: 0.02 BTC
   │     └─ 订单 ID: local_order_002
   │
   ├─ 并发提交 (10:30:00.250):
   │  ├─ 提交 Binance 买入订单
   │  ├─ 提交 OKX 卖出订单
   │  └─ 启动超时计时器 (5 秒)
   │
   ├─ 订单状态监控 (轮询间隔 100ms):
   │  ├─ 10:30:00.350: Binance 订单状态 → NEW (已挂单)
   │  ├─ 10:30:00.360: OKX 订单状态 → NEW (已挂单)
   │  ├─ 10:30:00.500: Binance 订单状态 → FILLED (完全成交) ✅
   │  ├─ 10:30:00.520: OKX 订单状态 → FILLED (完全成交) ✅
   │  └─ 总耗时: 270ms
   │
   └─ 成交详情:
      ├─ Binance:
      │  ├─ 成交价格: 43,000.50 USDT
      │  ├─ 成交数量: 0.02 BTC
      │  ├─ 手续费: 8.60 USDT (0.1%)
      │  └─ 实际花费: 860.01 USDT
      │
      └─ OKX:
         ├─ 成交价格: 43,149.80 USDT
         ├─ 成交数量: 0.02 BTC
         ├─ 手续费: 8.63 USDT (0.1%)
         └─ 实际收入: 862.99 USDT

5. 【收益计算阶段】
   ├─ 收入: 862.99 USDT
   ├─ 成本: 860.01 USDT
   ├─ 净收益: 862.99 - 860.01 = 2.98 USDT
   ├─ 净收益率: 2.98 / 860.01 = 0.347%
   ├─ 资金占用时间: 0.27 秒
   └─ 年化收益率: 0.347% × (365 × 24 × 3600 / 0.27) = 40,642%

6. 【数据记录阶段】
   ├─ 更新账户余额:
   │  ├─ Binance USDT: 10,000 → 9,139.99
   │  ├─ Binance BTC: 0 → 0.02
   │  ├─ OKX USDT: 0 → 862.99
   │  └─ OKX BTC: 0.25 → 0.23
   │
   ├─ 记录交易日志:
   │  ├─ 交易执行记录
   │  ├─ 订单详情记录
   │  └─ 收益统计
   │
   └─ 更新风险指标:
      ├─ 日交易次数: 1
      ├─ 日交易金额: 860 USDT
      ├─ 累计收益: +2.98 USDT
      └─ 胜率: 100% (1/1)
```

### 6.2 异常场景处理流程

**场景 1: 买入成交，卖出失败**

```
1. Binance 买入订单成交 ✅
2. OKX 卖出订单失败 (原因: 余额不足) ❌

异常处理流程:
├─ 步骤 1: 检测到卖出失败
├─ 步骤 2: 立即取消 OKX 卖出订单 (如果已挂单)
├─ 步骤 3: 重新检查 OKX 余额
│  └─ 发现: 之前计算的 0.25 BTC 不可用 (被其他交易占用)
├─ 步骤 4: 触发异常处理策略
│  ├─ 策略选项 A: 持有 BTC，等待下一次卖出机会
│  ├─ 策略选项 B: 在 Binance 反向卖出 (如果有足够 BTC)
│  └─ 选择: 策略 A (持有资产)
├─ 步骤 5: 记录异常日志
│  ├─ 异常类型: 卖出订单失败
│  ├─ 失败原因: 余额不足
│  ├─ 持有资产: 0.02 BTC @ Binance
│  └─ 风险评估: 价格波动风险
├─ 步骤 6: 触发告警
│  ├─ 告警级别: WARNING
│  ├─ 告警内容: "卖出失败，持有 0.02 BTC"
│  └─ 通知方式: Telegram + 邮件
└─ 步骤 7: 后续监控
   ├─ 持续监控 BTC 价格
   ├─ 监控 OKX 余额恢复
   └─ 等待下一次套利机会对冲持仓
```

**场景 2: 价格剧烈波动导致订单亏损**

```
1. 10:30:00.000: 发现套利机会 (收益率 0.8%)
2. 10:30:00.100: 提交订单
3. 10:30:00.500: 买入订单成交 ✅
4. 10:30:01.000: 市场突发利空，BTC 价格暴跌 5%
5. 10:30:01.500: 卖出订单成交，但价格不利 ❌

异常处理流程:
├─ 步骤 1: 检测价格异常波动
│  ├─ OKX 价格从 43,150 跌至 41,000
│  └─ 波动幅度: (41,000 - 43,150) / 43,150 = -4.99%
├─ 步骤 2: 立即触发价格保护机制
│  ├─ 滑点超过容忍度 (0.1%)
│  ├─ 自动撤销未成交订单
│  └─ 停止新交易 1 分钟
├─ 步骤 3: 计算实际损失
│  ├─ 买入成本: 43,000 × 0.02 = 860 USDT
│  ├─ 卖出收入: 41,000 × 0.02 = 820 USDT
│  ├─ 手续费: 8.6 + 8.2 = 16.8 USDT
│  └─ 净损失: 860 - 820 + 16.8 = 56.8 USDT
├─ 步骤 4: 触发熔断器
│  ├─ 单笔亏损 56.8 < 阈值 100 USDT (未触发)
│  ├─ 但价格波动 > 5%，触发市场熔断
│  └─ 暂停所有交易 5 分钟
└─ 步骤 5: 记录和分析
   ├─ 记录异常交易日志
   ├─ 分析失败原因
   ├─ 更新风险指标
   └─ 优化价格保护策略
```

### 6.3 系统状态机

```
系统状态转换:

[初始化] → [启动中] → [运行中] → [暂停] → [停止]
    ↑           ↓           ↓           ↓
    └───────────┴───────────┴───────────┘

状态定义:
├─ INIT (初始化): 加载配置，连接交易所
├─ STARTING (启动中): 初始化各模块，验证连接
├─ RUNNING (运行中):
│  ├─ 正常监控价格
│  ├─ 执行套利交易
│  └─ 更新风险指标
├─ PAUSED (暂停):
│  ├─ 触发熔断器
│  ├─ 手动暂停
│  └─ 停止新交易，保留已有订单
└─ STOPPED (停止):
   ├─ 手动停止
   ├─ 致命错误
   └─ 取消所有订单，释放资源

状态转换条件:
├─ INIT → STARTING: 配置加载成功
├─ STARTING → RUNNING: 所有模块就绪
├─ RUNNING → PAUSED: 触发熔断器
├─ PAUSED → RUNNING: 熔断器恢复，手动确认
├─ ANY → STOPPED: 手动停止或致命错误
└─ STOPPED → INIT: 重新启动
```

### 6.4 数据流图

```
┌──────────────┐
│ 交易所 APIs  │
└──────┬───────┘
       │ WebSocket/REST
       │ 价格数据、订单状态
       ↓
┌──────────────────┐
│  价格监控模块    │ → [价格数据流]
└──────┬───────────┘
       │ 实时价格
       ↓
┌──────────────────┐
│ 套利机会识别模块 │ → [套利机会]
└──────┬───────────┘
       │ 机会信号
       ↓
┌──────────────────┐
│  风险控制模块    │ → [通过/拒绝]
└──────┬───────────┘
       │ 通过
       ↓
┌──────────────────┐
│  交易执行模块    │ → [订单]
└──────┬───────────┘
       │ 订单状态
       ↓
┌──────────────────┐
│  账户管理模块    │ → [余额更新]
└──────┬───────────┘
       │ 交易数据
       ↓
┌──────────────────┐     ┌──────────────┐
│  日志监控模块    │ ──→ │ 数据库存储   │
└──────┬───────────┘     └──────────────┘
       │
       │ 异常事件
       ↓
┌──────────────────┐
│   告警模块       │ → [邮件/Telegram]
└──────────────────┘
```

## 7. 约束条件

### 7.1 技术约束
- 后端开发语言：Go
- 后端框架：go-zero
- 不开发前端界面
- 所有配置通过配置文件管理

### 6.2 业务约束
- 仅支持主流币种（BTC, ETH, USDT, USDC 等）
- 需要遵守各交易所的 API 限流规则
- 需要考虑各交易所的最小交易金额限制
- 需要考虑区块链网络确认时间（DEX 场景）

### 6.3 法律合规
- 需要遵守各国家和地区的金融监管政策
- 不支持恶意套利行为
- 需要做好 KYC 和 AML（针对用户）

## 7. 里程碑计划

### Phase 1: MVP 版本（4-6 周）
- [ ] 支持 2-3 个主流 CEX
- [ ] 支持 5 个主流交易对
- [ ] 实现基础的 CEX-CEX 套利
- [ ] 实现基础的风险控制
- [ ] 实现日志和基础监控

### Phase 2: 功能完善（4-6 周）
- [ ] 支持更多 CEX（目标 10+）
- [ ] 支持 DEX 集成
- [ ] 实现多种套利模式
- [ ] 完善告警系统
- [ ] 性能优化

### Phase 3: 高级特性（按需开发）
- [ ] 跨链套利
- [ ] 复杂套利策略（三角套利等）
- [ ] 机器学习预测
- [ ] Web 管理界面

## 8. 成功指标

### 8.1 技术指标
- 系统稳定性：运行 30 天无重大故障
- 套利机会捕获率：≥ 95%
- 交易执行成功率：≥ 95%
- 系统响应时间：满足性能要求

### 8.2 业务指标
- 月收益率：≥ 2%（取决于市场情况）
- 最大回撤：≤ 5%
- 夏普比率：≥ 2

## 9. 风险与挑战

### 9.1 技术风险
- 交易所 API 不稳定性
- 网络延迟影响套利效果
- 高并发场景下的性能瓶颈

### 9.2 业务风险
- 市场流动性不足导致滑点过大
- 交易所突然调整费率
- 资金安全问题

### 9.3 应对措施
- 多交易所备份，分散风险
- 完善的熔断机制
- 实时监控和告警
- 定期安全审计

## 10. 依赖资源

### 10.1 人力资源
- 后端开发工程师（Go）
- 测试工程师
- 运维工程师

### 10.2 技术资源
- 开发服务器
- 测试环境（交易所测试网）
- 生产服务器
- 数据库服务
- 监控告警系统

### 10.3 外部依赖
- 各交易所 API 文档
- 第三方 Go 库（HTTP 客户端、WebSocket 客户端等）

---

**文档版本**: v2.0
**创建日期**: 2026-01-06
**最后更新**: 2026-01-07
**维护人**: 开发团队

**更新日志**:
- v2.0 (2026-01-07): 聚焦核心功能，补充详细业务逻辑
  - 补充套利机会识别模块的详细计算逻辑和决策规则
  - 补充交易执行模块的详细流程和 8 种异常处理场景
  - 补充风险控制模块的资金管理策略和熔断机制
  - 新增核心业务流程章节（含完整示例流程）
  - 新增异常场景处理流程
  - 新增系统状态机和数据流图
- v1.0 (2026-01-06): 初始版本
